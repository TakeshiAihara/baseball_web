{% extends 'base.html' %}
{% block title %}é€šç®—æˆç¸¾ãƒšãƒ¼ã‚¸{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='top.css') }}">
<h1>é€šç®—æˆç¸¾ãƒšãƒ¼ã‚¸</h1>
<nav>
  <a href="/">TOP</a> |
  <a href="/record">è©¦åˆè¨˜éŒ²</a> |
  <a href="/summary">é€šç®—æˆç¸¾</a> |
  <a href="/players">é¸æ‰‹æˆç¸¾</a> |
  <a href="/about">ãã®ä»–</a>
</nav>

<!-- 1. é€šç®—æˆç¸¾ -->
<section style="margin-top:2em;">
  <h2>é€šç®—æˆç¸¾</h2>
  <div>
    <table border="1" cellpadding="6" style="background:#fff;">
      <tr><th>è©¦åˆæ•°</th><th>å‹åˆ©æ•°</th><th>æ•—åŒ—æ•°</th><th>å¼•åˆ†æ•°</th><th>å‹ç‡</th></tr>
      <tr>
        <td>{{ total_games }}</td>
        <td>{{ win_count }}</td>
        <td>{{ lose_count }}</td>
        <td>{{ draw_count }}</td>
        <td>{{ win_rate }}</td>
      </tr>
    </table>
  </div>

  <div style="min-width:320px; max-width:420px;">
    <h3 style="margin-bottom:0.2em;">è²¯é‡‘æ•°ã‚°ãƒ©ãƒ•</h3>
    <canvas id="cumulativeChart" width="480" height="320"></canvas>
    <script>
      const ctx = document.getElementById('cumulativeChart').getContext('2d');
      const chokinData = {{ cumulative_results | default([]) | tojson }};
      const labels = Array.from({length: chokinData.length}, (_, i) => i);
      // å‹•çš„ã«è‰²ã‚’æ±ºå®šï¼ˆåŒºé–“ã”ã¨ã«èµ¤/é’ã§åˆ†ã‘ã‚‹ï¼‰
      function getSegmentColor(ctx) {
        const {p0, p1} = ctx;
        // ä¸¡ç«¯ãŒ0ä»¥ä¸Šãªã‚‰èµ¤ã€ãã‚Œä»¥å¤–ï¼ˆè² ã‚’å«ã‚€ï¼‰ã¯é’
        if (p0.parsed.y >= 0 && p1.parsed.y >= 0) return 'red';
        return 'blue';
      }
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'è²¯é‡‘æ•°ã®æ¨ç§»',
            data: chokinData,
            borderColor: function(context) {
              // Chart.js v3+ ã§ã¯ borderColor ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«è‰²åˆ†ã‘å¯èƒ½
              const chart = context.chart;
              const {ctx, chartArea} = context;
              if (!chartArea) return 'black'; // åˆæœŸæç”»
              return undefined; // segment.colorã§åˆ¶å¾¡
            },
            segment: {
              borderColor: getSegmentColor
            },
            borderWidth: 1,
            pointRadius: 1,
            pointBackgroundColor: 'black', // ç‚¹ã¯å¸¸ã«é»’
            fill: false,
          }]
        },
        options: {
          scales: {
            y: {
              title: { display: true, text: 'è²¯é‡‘æ•°' },
              beginAtZero: true,
              ticks: {
                stepSize: 1
              },
              grid: {
                color: function(context) {
                  if (context.tick.value === 0) {
                    return '#000'; // 0ã®è£œåŠ©ç·šã‚’é»’ã«
                  }
                  return Chart.defaults.borderColor;
                },
                lineWidth: function(context) {
                  return context.tick.value === 0 ? 2 : 1;
                }
              }
            },
            x: {
              title: { display: true, text: 'è©¦åˆæ•°' }
            }
          },
          plugins: {
            legend: { display: true },
            title: { display: false }
          },
          elements: {
            line: { fill: false }
          }
        }
      });

    </script>
  </div>
</div>
</section>

<!-- 2. å¯¾æˆ¦ãƒãƒ¼ãƒ ã”ã¨ã®è©¦åˆæ•°ãƒ»å‹ç‡ï¼†é€šç®—æˆç¸¾ -->
<section style="margin-top:2em; display: flex; flex-wrap: wrap; gap: 2em; align-items: flex-start;">
  <div>
    <h2>å¯¾æˆ¦ãƒãƒ¼ãƒ ã”ã¨ã®æˆç¸¾</h2>
    <table border="1" cellpadding="6" style="background:#fff;">
      <tr><th>ãƒãƒ¼ãƒ å</th><th>è©¦åˆæ•°</th><th>å‹</th><th>æ•—</th><th>å¼•åˆ†</th><th>å‹ç‡</th></tr>
      {% for row in vs_team_stats %}
      <tr>
        <td>{{ row.team }}</td>
        <td>{{ row.games }}</td>
        <td>{{ row.win }}</td>
        <td>{{ row.lose }}</td>
        <td>{{ row.draw }}</td>
        <td>{{ row.win_rate }}</td>
      </tr>
      {% endfor %}
    </table>
      <h2>å¹´åº¦ã”ã¨ã®æˆç¸¾</h2>
      <table border="1" cellpadding="6" style="background:#fff;">
        <tr><th>å¹´åº¦</th><th>è©¦åˆæ•°</th><th>å‹</th><th>æ•—</th><th>å¼•åˆ†</th><th>å‹ç‡</th></tr>
        {% for year_data in yearly_stats %}
        <tr>
          <td>{{ year_data.year }}å¹´</td>
          <td>{{ year_data.games }}</td>
          <td>{{ year_data.win }}</td>
          <td>{{ year_data.lose }}</td>
          <td>{{ year_data.draw }}</td>
          <td>{{ year_data.win_rate }}</td>
        </tr>
        {% endfor %}
      </table>
      
      <!-- å¹´åº¦ã”ã¨æˆç¸¾ã®æ£’ã‚°ãƒ©ãƒ• -->
        <h2>å¹´åº¦åˆ¥æˆç¸¾ã‚°ãƒ©ãƒ•</h2>
        <canvas id="yearlyBarChart"></canvas>
      <script>
        // Wait for the page to fully load
        document.addEventListener('DOMContentLoaded', function() {
        
          // 1. Get the drawing area (canvas)
          const ctx = document.getElementById('yearlyBarChart').getContext('2d');
        
          // 2. Get data from your backend (passed via Jinja2)
          // This safely converts your Python list into a JavaScript array.
          const yearData = {{ yearly_stats | tojson | safe }};
        
          // If data is empty, don't try to draw the chart
          if (!yearData || yearData.length === 0) {
            console.log("Chart data (year_data) is empty. The chart will not be displayed.");
            return;
          }
        
          // 3. Prepare data for the chart
          const labels = yearData.map(item => item.year + 'å¹´'); // e.g., ["2024å¹´", "2025å¹´"]
          const wins = yearData.map(item => item.win);
          const losses = yearData.map(item => item.lose);
          const draws = yearData.map(item => item.draw);
        
          // 4. Create the chart instance
          new Chart(ctx, {
            type: 'bar', // Specify the chart type
            data: {
              labels: labels,
              datasets: [{
                label: 'å‹ã¡',
                data: wins,
                backgroundColor: 'rgba(255, 99, 132, 0.8)'  // Red
              }, {
                label: 'è² ã‘',
                data: losses,
                backgroundColor: 'rgba(54, 162, 235, 0.8)' // Blue
              }, {
                label: 'å¼•ãåˆ†ã‘',
                data: draws,
                backgroundColor: 'rgba(201, 203, 207, 0.8)' // Gray
              }]
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: 'å¹´åº¦ã”ã¨ã®å‹æ•—æ•°'
                },
                legend: {
                  position: 'top',
                }
              },
              scales: {
                x: {
                  stacked: true, // Stack bars on the X-axis
                },
                y: {
                  stacked: true, // Stack bars on the Y-axis
                  beginAtZero: true
                }
              }
            }
          });
        });
      </script>
    </div>
    
</section>

<!-- 2.5 ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆè¨ˆãƒ»å¹³å‡ãƒ†ãƒ¼ãƒ–ãƒ« -->
<section style="margin-top:2em;">
  <h2>ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆè¨ˆãƒ»å¹³å‡</h2>
  
  <!-- åŸºæœ¬æˆç¸¾ -->
  <div style="margin-bottom: 2em;">
    <h3>åŸºæœ¬æˆç¸¾</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="4" style="background:#fff; min-width:300px;">
        <tr>
          <th>é …ç›®</th>
          {% for col in basic_sum.keys() %}<th>{{ col }}</th>{% endfor %}
        </tr>
        <tr>
          <td>åˆè¨ˆ</td>
          {% for col in basic_sum.keys() %}<td>{{ basic_sum[col] }}</td>{% endfor %}
        </tr>
        <tr>
          <td>å¹³å‡</td>
          {% for col in basic_avg.keys() %}<td>{{ basic_avg[col] }}</td>{% endfor %}
        </tr>
      </table>
    </div>
  </div>
  <table border="1" cellpadding="6" style="background:#fff;">
    <tr><th>é€šç®—æ‰“ç‡</th><th>é€šç®—æœ¬å¡æ‰“ç‡</th><th>é€šç®—OPS</th><th>é€šç®—é˜²å¾¡ç‡</th><th>é€šç®—è¢«æ‰“ç‡</th><th>é€šç®—è¢«æœ¬å¡æ‰“ç‡</th></tr>
    <tr>
      <td>{{ avg_batting }}</td>
      <td>{{ hr_rate }}</td>
      <td>{{ ops }}</td>
      <td>{{ era }}</td>
      <td>{{ opp_avg }}</td>
      <td>{{ opp_hr_rate }}</td>
    </tr>
  </table>
  
  <!-- æ‰“æ’ƒæˆç¸¾ -->
  <div style="margin-bottom: 2em;">
    <h3>ğŸ‰ æ‰“æ’ƒæˆç¸¾</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="4" style="background:#fff; min-width:600px;">
        <tr>
          <th>é …ç›®</th>
          {% for col in batting_sum.keys() %}<th>{{ col }}</th>{% endfor %}
        </tr>
        <tr>
          <td>åˆè¨ˆ</td>
          {% for col in batting_sum.keys() %}<td>{{ batting_sum[col] }}</td>{% endfor %}
        </tr>
        <tr>
          <td>å¹³å‡</td>
          {% for col in batting_avg.keys() %}<td>{{ batting_avg[col] }}</td>{% endfor %}
        </tr>
      </table>
    </div>
  </div>
  
  <!-- æŠ•æ‰‹æˆç¸¾ -->
  <div style="margin-bottom: 2em;">
    <h3>âš¾ æŠ•æ‰‹æˆç¸¾</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="4" style="background:#fff; min-width:600px;">
        <tr>
          <th>é …ç›®</th>
          {% for col in pitching_sum.keys() %}<th>{{ col }}</th>{% endfor %}
        </tr>
        <tr>
          <td>åˆè¨ˆ</td>
          {% for col in pitching_sum.keys() %}<td>{{ pitching_sum[col] }}</td>{% endfor %}
        </tr>
        <tr>
          <td>å¹³å‡</td>
          {% for col in pitching_avg.keys() %}<td>{{ pitching_avg[col] }}</td>{% endfor %}
        </tr>
      </table>
    </div>
  </div>
  
  <!-- ç›¸æ‰‹ãƒãƒ¼ãƒ æˆç¸¾ -->
  <div style="margin-bottom: 2em;">
    <h3>ğŸ‘¥ ç›¸æ‰‹ãƒãƒ¼ãƒ æˆç¸¾</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="4" style="background:#fff; min-width:400px;">
        <tr>
          <th>é …ç›®</th>
          {% for col in opponent_sum.keys() %}<th>{{ col }}</th>{% endfor %}
        </tr>
        <tr>
          <td>åˆè¨ˆ</td>
          {% for col in opponent_sum.keys() %}<td>{{ opponent_sum[col] }}</td>{% endfor %}
        </tr>
        <tr>
          <td>å¹³å‡</td>
          {% for col in opponent_avg.keys() %}<td>{{ opponent_avg[col] }}</td>{% endfor %}
        </tr>
      </table>
    </div>
  </div>
  
  <!-- è©¦åˆæƒ…å ± -->
  <div style="margin-bottom: 2em;">
    <h3>ğŸ“Š è©¦åˆæƒ…å ±</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="4" style="background:#fff; min-width:300px;">
        <tr>
          <th>é …ç›®</th>
          <th>è©¦åˆæ™‚é–“</th>
          <th>å…¥å ´è€…æ•°</th>
        </tr>
        <tr>
          <td>å¹³å‡</td>
          <td>{{ avg_time }}</td>
          <td>{{ avg_att }}äºº</td>
        </tr>
        <tr>
          <td>åˆè¨ˆ</td>
          <td>{{ sum_time }}</td>
          <td>{{ sum_att }}äºº</td>
        </tr>
      </table>
    </div>
  </div>
</section>

<!-- 3. å…¨è©¦åˆè©³ç´° -->
<section style="margin-top:2em;">
  <h2>å…¨è©¦åˆè©³ç´°</h2>
  <!-- ã“ã“ã§ã¯å…¨è©¦åˆã®è©³ç´°ãªçµæœä¸€è¦§ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™ã€‚å„è©¦åˆã®æƒ…å ±ã‚’ç¢ºèªã—ã€ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã§å†…å®¹ã‚’ä¿®æ­£ã€ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã§è©²å½“è©¦åˆã‚’å‰Šé™¤ã§ãã¾ã™ã€‚ -->
  <div style="overflow-x:auto;">
    <table border="1" cellpadding="4" style="background:#fff; min-width:1200px;">
      <tr>
        {% for col in columns %}
          {% if col.startswith('è‡ªãƒãƒ¼ãƒ _') %}
            <th> {{ col.replace('è‡ªãƒãƒ¼ãƒ _', '') }}</th>
          {% elif col.startswith('ç›¸æ‰‹ãƒãƒ¼ãƒ _') %}
            <th>ğŸ‘¥ {{ col.replace('ç›¸æ‰‹ãƒãƒ¼ãƒ _', '') }}</th>
          {% elif col == 'ãƒãƒ¼ãƒ å' %}
            <th>ãƒãƒ¼ãƒ </th>
          {% elif col == 'ç›¸æ‰‹ãƒãƒ¼ãƒ ' %}
            <th>ç›¸æ‰‹</th>
          {% elif col == 'ãƒ›ãƒ¼ãƒ /ãƒ“ã‚¸ã‚¿ãƒ¼' %}
            <th>å ´æ‰€</th>
          {% else %}
            <th>{{ col }}</th>
          {% endif %}
        {% endfor %}
        <th>æ“ä½œ</th> <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </tr>
      {% for match in matches %}
      <tr>
        {% for col in columns %}
          {% if col == 'URL' and match[col] %}
            <td><a href="{{ match[col] }}" target="_blank">ãƒªãƒ³ã‚¯</a></td>
          {% elif col == 'æ—¥ä»˜' %}
            <td>{{ match[col][:10] if match[col] else '' }}</td>
          {% elif col == 'ãƒ›ãƒ¼ãƒ /ãƒ“ã‚¸ã‚¿ãƒ¼' %}
            <td>
              {% if match[col] == 'ãƒ›ãƒ¼ãƒ ' %}
                ãƒ›ãƒ¼ãƒ 
              {% elif match[col] == 'ãƒ“ã‚¸ã‚¿ãƒ¼' %}
                ãƒ“ã‚¸ã‚¿ãƒ¼
              {% else %}
                {{ match[col] }}
              {% endif %}
            </td>
          {% elif col == 'å‹æ•—' %}
            <td>
              {% if match[col] == 'å‹' %}
                <span class="result-win">{{ match[col] }}</span>
              {% elif match[col] == 'æ•—' %}
                <span class="result-lose">{{ match[col] }}</span>
              {% elif match[col] == 'å¼•åˆ†' %}
                <span class="result-draw">{{ match[col] }}</span>
              {% else %}
                {{ match[col] }}
              {% endif %}
            </td>
          {% else %}
            <td>{{ match[col] }}</td>
          {% endif %}
        {% endfor %}
        <td>
          <a href="/edit_match_by_date?date={{ match['æ—¥ä»˜'] | urlencode }}&team={{ match['ãƒãƒ¼ãƒ å'] | urlencode }}" style="display:inline-block; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 3px; margin-right: 5px;">ç·¨é›†</a>
          <form method="post" action="/delete_match/{{ loop.index0 }}" style="display:inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
            <button type="submit">å‰Šé™¤</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</section>
{% endblock %}
